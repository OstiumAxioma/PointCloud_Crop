# 点云处理应用

这是一个基于VTK 8.2.0和Qt 5.12.9的点云可视化与处理应用，支持PLY文件导入、3D可视化、多种形状选择（矩形、圆形、多边形）和点云高亮功能。

## 项目结构

```
PointCloud_Crop/
├── CMakeLists.txt          # CMake配置文件
├── build.bat              # Windows构建脚本
├── generate_vscode_config.py # VSCode配置生成脚本
├── README.md              # 项目说明
├── header/                # 头文件目录
│   ├── mainwindow.h       # 主窗口头文件
│   ├── pointcloudviewer.h # 点云查看器头文件
│   ├── fileimporter.h     # 文件导入器头文件
│   └── selector.h         # 多形状选择器头文件
└── src/                   # 源文件目录
    ├── main.cpp           # 主程序入口
    ├── mainwindow.cpp     # 主窗口实现
    ├── mainwindow.ui      # Qt Designer UI文件
    ├── pointcloudviewer.cpp # 点云查看器实现
    ├── fileimporter.cpp   # 文件导入器实现
    └── selector.cpp       # 多形状选择器实现
```

## 环境要求

- **VTK**: 8.2.0 
  - 源码位置: `D:\code\vtk8.2.0\VTK-8.2.0\`
  - 编译输出: `D:\code\vtk8.2.0\VTK-8.2.0\bin`
  - CMake配置: `D:\code\vtk8.2.0\VTK-8.2.0\lib\cmake\vtk-8.2`
- **Qt**: 5.12.9 (安装在 `C:\Qt\Qt5.12.9\5.12.9\msvc2017_64`)
- **编译器**: Visual Studio 2022 或更高版本
- **CMake**: 3.14 或更高版本

## 最新更新

### v2.0 功能增强
- ✅ **多形状选择**: 新增圆形和多边形选择模式
- ✅ **智能遮挡检测**: 基于深度缓冲的自动遮挡检测
- ✅ **交互式多边形绘制**: 支持逐点绘制，Backspace撤销
- ✅ **累积选择**: 多次选择结果累积，不覆盖
- ✅ **状态管理**: 自动清理选择状态，优化用户体验
- ✅ **射线法算法**: 高精度多边形内点判断
- ✅ **实时预览**: 绘制过程中实时显示选择框
- ✅ **键盘交互**: 支持Backspace撤销操作

## 构建步骤

### 方法1: 使用构建脚本 (推荐)
```bash
# 在项目根目录运行
build.bat
```

### 方法2: 手动构建
```bash
# 创建构建目录
mkdir build
cd build

# 配置项目
cmake .. -G "Visual Studio 17 2022" -A x64

# 构建项目
cmake --build . --config Release
```

## 功能特性

- **PLY文件导入**: 支持导入PLY格式的点云文件
- **3D可视化**: 使用VTK进行点云3D渲染，支持Z轴渐变色显示
- **多形状选择**: 支持矩形、圆形、多边形三种选择模式
- **智能选择**: 支持遮挡检测，优先选择距离相机较近的点
- **交互式绘制**: 多边形模式支持逐点绘制，Backspace撤销
- **点云高亮**: 选中的点以红色高亮显示
- **累积选择**: 支持多次选择，选中点累积高亮
- **交互式操作**: 支持鼠标旋转、平移、缩放3D场景
- **Qt界面**: 现代化的Qt用户界面，包含菜单、工具栏和状态栏

## 核心功能

### 点云导入与显示
- 通过菜单或工具栏导入PLY文件
- 自动根据Z坐标生成渐变色显示
- 支持点云统计信息显示（点数、面片数、Z范围）

### 多形状选择功能

#### 矩形选择
- 点击"矩形选择"按钮启用矩形选择模式
- 鼠标拖拽绘制矩形选择框
- 实时显示选择框，不随3D场景旋转

#### 圆形选择
- 点击"圆形选择"按钮启用圆形选择模式
- 鼠标拖拽绘制圆形选择区域
- 以拖拽起点和终点为对角线的矩形的内切圆为选择区域

#### 多边形选择
- 点击"多边形选择"按钮启用多边形选择模式
- 左键依次点击放置多边形顶点
- Backspace键撤销最后一个顶点
- 右键完成多边形绘制并执行选择
- 支持任意复杂形状的精确选择

#### 遮挡检测
- 默认启用深度选择功能
- 自动检测点云遮挡关系，优先选择距离相机较近的点
- 可通过工具栏复选框开启/关闭此功能

#### 选择特性
- 支持多次选择，选中点累积高亮
- 所有选择模式互斥，激活一种会自动关闭其他模式
- 切换选择模式时自动清理当前绘制状态

### 选择管理
- 选中点以红色高亮显示
- 支持清除所有选中点，恢复原始颜色
- 选中状态持久保存，直到手动清除

## 数据流路径

### 选择过程
1. `PerformPointSelection()` → 检测哪些点在选择框内
2. 将新选中的点ID添加到 `selectedPointIds` 向量中
3. `selectedPointIds.insert(selectedPointIds.end(), newSelectedPointIds.begin(), newSelectedPointIds.end());`

### 高亮显示
1. `HighlightSelectedPoints(selectedPointIds)` → 根据ID列表修改点云颜色
2. 直接修改 `originalPointData` 中对应点的颜色为红色
3. 未选中的点保持原始渐变色

### 清除选择
1. `ClearAllSelectedPoints()` → 清空 `selectedPointIds` 并恢复原始颜色
2. 从 `originalColorBackup` 恢复所有点的原始颜色

## 选择算法

### 几何判断
- **矩形选择**: 使用AABB（轴对齐包围盒）算法判断点是否在矩形内
- **圆形选择**: 计算点到圆心的欧几里得距离，与半径比较
- **多边形选择**: 使用射线法（Ray Casting）算法判断点是否在多边形内

### 遮挡检测
- **深度缓冲**: 基于屏幕空间的像素级深度检测
- **距离排序**: 按点到相机距离排序，优先处理近距离点
- **阈值过滤**: 使用相对距离阈值过滤被遮挡的点
- **像素邻域**: 考虑点在屏幕空间的像素邻域影响

### 坐标变换
- **世界坐标→屏幕坐标**: 使用VTK的投影矩阵进行坐标变换
- **屏幕空间选择**: 所有选择操作在2D屏幕坐标系中进行
- **实时渲染**: 选择框使用VTK 2D Actor，不受3D场景变换影响

## 技术架构

### 主要类说明
- **MainWindow**: 主窗口，负责UI和信号槽连接
- **PointCloudViewer**: 点云查看器，集成VTK渲染窗口
- **FileImporter**: 文件导入器，处理PLY文件选择
- **Selector**: 多形状选择器，实现矩形、圆形、多边形选择功能

### 数据存储
- 选中点存储在 `Selector::selectedPointIds` 中（点ID列表）
- 原始颜色备份在 `Selector::originalColorBackup` 中
- 多边形顶点存储在 `Selector::polygonVertices` 中
- 点云数据通过 `vtkPolyData` 管理

## 使用方法

### 基本操作
1. **启动应用**: 运行构建后的可执行文件
2. **导入点云**: 点击"导入PLY"按钮选择PLY文件
3. **3D交互**: 使用鼠标旋转、平移、缩放查看点云

### 矩形选择
1. **启用选择**: 点击"矩形选择"按钮
2. **绘制选择框**: 在点云上拖拽鼠标绘制矩形框
3. **查看结果**: 选中的点会以红色高亮显示

### 圆形选择
1. **启用选择**: 点击"圆形选择"按钮
2. **绘制选择区域**: 在点云上拖拽鼠标，以起终点为对角线的矩形内切圆为选择区域
3. **查看结果**: 选中的点会以红色高亮显示

### 多边形选择
1. **启用选择**: 点击"多边形选择"按钮
2. **绘制顶点**: 左键依次点击放置多边形顶点
3. **撤销顶点**: 按Backspace键撤销最后一个顶点
4. **完成选择**: 右键完成多边形绘制并执行选择
5. **查看结果**: 选中的点会以红色高亮显示

### 高级功能
- **深度选择**: 通过工具栏复选框启用/禁用遮挡检测
- **累积选择**: 多次选择会累积高亮，不会覆盖之前的选择
- **清除选择**: 点击"清除选择"按钮恢复原始显示

## 故障排除

### 常见问题

1. **VTK路径错误**: 确保VTK_DIR路径正确指向您的VTK安装目录
2. **Qt路径错误**: 确保Qt5_DIR路径正确指向您的Qt安装目录
3. **编译器版本**: 确保使用与Qt和VTK兼容的编译器版本
4. **PLY文件格式**: 确保PLY文件格式正确，包含点坐标数据

### 调试信息
如果构建失败，请检查：
- CMake错误信息
- 编译器错误信息
- 路径配置是否正确
- VTK和Qt版本兼容性

## 许可证

本项目仅供学习和研究使用。 