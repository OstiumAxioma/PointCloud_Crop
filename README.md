# 点云处理应用

这是一个基于VTK 8.2.0和Qt 5.12.9的点云可视化与处理应用，支持PLY文件导入、3D可视化、多种形状选择（矩形、圆形、多边形）和点云高亮功能。

## 项目结构

```
PointCloud_Crop/
├── CMakeLists.txt          # CMake配置文件
├── build.bat              # Windows构建脚本
├── generate_vscode_config.py # VSCode配置生成脚本
├── README.md              # 项目说明
├── header/                # 头文件目录
│   ├── mainwindow.h       # 主窗口头文件
│   ├── pointcloudviewer.h # 点云查看器头文件
│   ├── fileimporter.h     # 文件导入器头文件
│   └── selector.h         # 多形状选择器头文件
└── src/                   # 源文件目录
    ├── main.cpp           # 主程序入口
    ├── mainwindow.cpp     # 主窗口实现
    ├── mainwindow.ui      # Qt Designer UI文件
    ├── pointcloudviewer.cpp # 点云查看器实现
    ├── fileimporter.cpp   # 文件导入器实现
    └── selector.cpp       # 多形状选择器实现
```

## 环境要求

- **VTK**: 8.2.0 
  - 源码位置: `D:\code\vtk8.2.0\VTK-8.2.0\`
  - 编译输出: `D:\code\vtk8.2.0\VTK-8.2.0\bin`
  - CMake配置: `D:\code\vtk8.2.0\VTK-8.2.0\lib\cmake\vtk-8.2`
- **Qt**: 5.12.9 (安装在 `C:\Qt\Qt5.12.9\5.12.9\msvc2017_64`)
- **编译器**: Visual Studio 2022 或更高版本
- **CMake**: 3.14 或更高版本

## 最新更新

### v2.0 功能增强
- ✅ **多形状选择**: 新增圆形和多边形选择模式
- ✅ **智能遮挡检测**: 基于深度缓冲的自动遮挡检测
- ✅ **交互式多边形绘制**: 支持逐点绘制，Backspace撤销
- ✅ **累积选择**: 多次选择结果累积，不覆盖
- ✅ **状态管理**: 自动清理选择状态，优化用户体验
- ✅ **射线法算法**: 高精度多边形内点判断
- ✅ **实时预览**: 绘制过程中实时显示选择框
- ✅ **键盘交互**: 支持Backspace撤销操作

### v3.0 矢量图形编辑系统
- ✅ **CAD风格编辑**: 图形绘制后可进行类似CAD的编辑操作
- ✅ **图形选择**: 点击图形变红色高亮，显示编辑控制点
- ✅ **矩形编辑**: 拖拽控制点调整大小，保持90度角不变
- ✅ **圆形编辑**: 拖拽控制点调整半径，支持Shift键保持比例
- ✅ **多边形编辑**: 点击显示顶点控制点，拖拽顶点改变形状
- ✅ **图形移动**: 拖拽整个图形进行位置移动
- ✅ **撤销系统**: Ctrl+Z撤销所有操作（添加、编辑、删除）
- ✅ **删除功能**: Del键删除选中图形（可撤销）
- ✅ **独立渲染**: 每个图形独立actor，选择状态互不影响
- ✅ **状态序列化**: 完整的图形状态保存和恢复机制

## 构建步骤

### 方法1: 使用构建脚本 (推荐)
```bash
# 在项目根目录运行
build.bat
```

### 方法2: 手动构建
```bash
# 创建构建目录
mkdir build
cd build

# 配置项目
cmake .. -G "Visual Studio 17 2022" -A x64

# 构建项目
cmake --build . --config Release
```

## 功能特性

- **PLY文件导入**: 支持导入PLY格式的点云文件
- **3D可视化**: 使用VTK进行点云3D渲染，支持Z轴渐变色显示
- **多形状选择**: 支持矩形、圆形、多边形三种选择模式
- **智能选择**: 支持遮挡检测，优先选择距离相机较近的点
- **交互式绘制**: 多边形模式支持逐点绘制，Backspace撤销
- **矢量图形编辑**: CAD风格的图形创建和编辑系统
- **图形选择与编辑**: 点击图形进行选择，拖拽控制点编辑形状
- **撤销与删除**: 完整的撤销系统，支持Ctrl+Z和Del键操作
- **点云高亮**: 选中的点以红色高亮显示
- **累积选择**: 支持多次选择，选中点累积高亮
- **交互式操作**: 支持鼠标旋转、平移、缩放3D场景
- **Qt界面**: 现代化的Qt用户界面，包含菜单、工具栏和状态栏

## 核心功能

### 点云导入与显示
- 通过菜单或工具栏导入PLY文件
- 自动根据Z坐标生成渐变色显示
- 支持点云统计信息显示（点数、面片数、Z范围）

### 多形状选择功能

#### 矩形选择
- 点击"矩形选择"按钮启用矩形选择模式
- 鼠标拖拽绘制矩形选择框
- 实时显示选择框，不随3D场景旋转

#### 圆形选择
- 点击"圆形选择"按钮启用圆形选择模式
- 鼠标拖拽绘制圆形选择区域
- 以拖拽起点和终点为对角线的矩形的内切圆为选择区域

#### 多边形选择
- 点击"多边形选择"按钮启用多边形选择模式
- 左键依次点击放置多边形顶点
- Backspace键撤销最后一个顶点
- 右键完成多边形绘制并执行选择
- 支持任意复杂形状的精确选择

#### 遮挡检测
- 默认启用深度选择功能
- 自动检测点云遮挡关系，优先选择距离相机较近的点
- 可通过工具栏复选框开启/关闭此功能

#### 选择特性
- 支持多次选择，选中点累积高亮
- 所有选择模式互斥，激活一种会自动关闭其他模式
- 切换选择模式时自动清理当前绘制状态

### 矢量图形编辑功能

#### 图形状态管理
- **正常状态**: 绿色线条显示，表示可用于选取的图形
- **选中状态**: 红色线条显示，表示当前编辑的图形
- **控制点显示**: 选中图形时显示黄色控制点，用于调整形状

#### 图形选择
- **点击选择**: 点击任意图形边界进行选择
- **状态切换**: 选择新图形时，之前选中的图形自动变回绿色
- **取消选择**: 点击空白区域取消所有选择
- **独立渲染**: 每个图形有独立的渲染对象，选择状态互不影响

#### 矩形编辑
- **角点控制**: 四个角点控制矩形的位置和大小
- **边中点控制**: 四个边中点控制矩形的宽度或高度
- **约束编辑**: 保持90度角不变，只允许拉伸操作
- **实时预览**: 拖拽过程中实时显示调整结果

#### 圆形编辑
- **半径控制**: 四个方向的控制点（上下左右）
- **中心固定**: 拖拽控制点调整半径，圆心位置保持不变
- **比例缩放**: 所有控制点功能相同，调整圆的大小
- **移动操作**: 拖拽圆的边界进行整体移动

#### 多边形编辑
- **顶点控制**: 每个顶点都是控制点，可以独立移动
- **形状变化**: 拖拽顶点改变多边形的形状
- **无缩放功能**: 不支持整体缩放，只支持顶点移动
- **自由编辑**: 可以创建任意复杂的多边形形状

#### 图形移动
- **整体拖拽**: 点击图形边界（非控制点）拖拽整个图形
- **位置保持**: 移动时保持图形的大小和形状不变
- **实时反馈**: 移动过程中实时更新图形位置

#### 键盘快捷键
- **Ctrl+Z**: 撤销上一个操作（添加、编辑、删除）
- **Del键**: 删除当前选中的图形（红色图形）
- **Backspace**: 多边形绘制时撤销最后一个顶点

#### 撤销系统
- **操作记录**: 自动记录所有图形操作（最多50个）
- **状态恢复**: 撤销时完整恢复图形的位置、大小、形状
- **命令模式**: 基于命令模式实现，支持复杂操作的撤销
- **类型支持**: 
  - 图形添加/删除
  - 图形移动
  - 图形形状编辑（顶点移动、缩放等）

### 选择管理
- 选中点以红色高亮显示
- 支持清除所有选中点，恢复原始颜色
- 选中状态持久保存，直到手动清除

## 数据流路径

### 选择过程
1. `PerformPointSelection()` → 检测哪些点在选择框内
2. 将新选中的点ID添加到 `selectedPointIds` 向量中
3. `selectedPointIds.insert(selectedPointIds.end(), newSelectedPointIds.begin(), newSelectedPointIds.end());`

### 高亮显示
1. `HighlightSelectedPoints(selectedPointIds)` → 根据ID列表修改点云颜色
2. 直接修改 `originalPointData` 中对应点的颜色为红色
3. 未选中的点保持原始渐变色

### 清除选择
1. `ClearAllSelectedPoints()` → 清空 `selectedPointIds` 并恢复原始颜色
2. 从 `originalColorBackup` 恢复所有点的原始颜色

## 选择算法

### 几何判断
- **矩形选择**: 使用AABB（轴对齐包围盒）算法判断点是否在矩形内
- **圆形选择**: 计算点到圆心的欧几里得距离，与半径比较
- **多边形选择**: 使用射线法（Ray Casting）算法判断点是否在多边形内

### 遮挡检测
- **深度缓冲**: 基于屏幕空间的像素级深度检测
- **距离排序**: 按点到相机距离排序，优先处理近距离点
- **阈值过滤**: 使用相对距离阈值过滤被遮挡的点
- **像素邻域**: 考虑点在屏幕空间的像素邻域影响

### 坐标变换
- **世界坐标→屏幕坐标**: 使用VTK的投影矩阵进行坐标变换
- **屏幕空间选择**: 所有选择操作在2D屏幕坐标系中进行
- **实时渲染**: 选择框使用VTK 2D Actor，不受3D场景变换影响

## 技术架构

### 主要类说明
- **MainWindow**: 主窗口，负责UI和信号槽连接
- **PointCloudViewer**: 点云查看器，集成VTK渲染窗口
- **FileImporter**: 文件导入器，处理PLY文件选择
- **Selector**: 多形状选择器，实现矢量图形编辑和点云选择功能

### 矢量图形系统架构
- **VectorShape**: 矢量图形基类，定义通用接口
  - **VectorRectangle**: 矢量矩形实现
  - **VectorCircle**: 矢量圆形实现
  - **VectorPolygon**: 矢量多边形实现
- **Command**: 命令基类，实现撤销系统
  - **AddShapeCommand**: 添加图形命令
  - **DeleteShapeCommand**: 删除图形命令
  - **EditShapeCommand**: 编辑图形命令（移动、变形）

### 数据存储
- 选中点存储在 `Selector::selectedPointIds` 中（点ID列表）
- 原始颜色备份在 `Selector::originalColorBackup` 中
- 点云数据通过 `vtkPolyData` 管理

### 矢量图形数据存储
- **图形容器**: `std::vector<std::unique_ptr<VectorShape>> vectorShapes`
- **渲染对象**: 每个图形独立的actor、mapper、polydata、points
- **编辑状态**: `selectedShape`、`currentOperation`、`isDragging`
- **撤销系统**: `std::stack<std::unique_ptr<Command>> commandHistory`
- **状态序列化**: 图形状态通过字符串序列化保存（用于撤销）

## 使用方法

### 基本操作
1. **启动应用**: 运行构建后的可执行文件
2. **导入点云**: 点击"导入PLY"按钮选择PLY文件
3. **3D交互**: 使用鼠标旋转、平移、缩放查看点云

### 矩形选择
1. **启用选择**: 点击"矩形选择"按钮
2. **绘制选择框**: 在点云上拖拽鼠标绘制矩形框
3. **查看结果**: 选中的点会以红色高亮显示

### 圆形选择
1. **启用选择**: 点击"圆形选择"按钮
2. **绘制选择区域**: 在点云上拖拽鼠标，以起终点为对角线的矩形内切圆为选择区域
3. **查看结果**: 选中的点会以红色高亮显示

### 多边形选择
1. **启用选择**: 点击"多边形选择"按钮
2. **绘制顶点**: 左键依次点击放置多边形顶点
3. **撤销顶点**: 按Backspace键撤销最后一个顶点
4. **完成选择**: 右键完成多边形绘制并执行选择
5. **查看结果**: 选中的点会以红色高亮显示

### 图形编辑操作

#### 选择图形
1. **退出绘制模式**: 确保不在绘制模式下（没有激活的绘制工具）
2. **点击图形**: 点击任意图形的边界进行选择
3. **查看状态**: 选中的图形变为红色，显示黄色控制点
4. **取消选择**: 点击空白区域取消选择

#### 编辑矩形
1. **选择矩形**: 点击矩形边界，图形变红色并显示8个控制点
2. **调整大小**: 拖拽角点或边中点调整矩形大小
3. **移动位置**: 拖拽矩形边界（非控制点区域）移动整个矩形
4. **完成编辑**: 点击空白区域或选择其他图形

#### 编辑圆形
1. **选择圆形**: 点击圆形边界，图形变红色并显示4个控制点
2. **调整半径**: 拖拽任意控制点调整圆的大小
3. **移动位置**: 拖拽圆形边界（非控制点区域）移动整个圆形
4. **完成编辑**: 点击空白区域或选择其他图形

#### 编辑多边形
1. **选择多边形**: 点击多边形边界，图形变红色并显示所有顶点控制点
2. **移动顶点**: 拖拽任意顶点控制点改变多边形形状
3. **移动整体**: 拖拽多边形边界（非顶点区域）移动整个多边形
4. **完成编辑**: 点击空白区域或选择其他图形

#### 删除图形
1. **选择图形**: 点击要删除的图形
2. **按删除键**: 按下Del键删除选中的图形
3. **撤销删除**: 可以使用Ctrl+Z撤销删除操作

#### 撤销操作
- **Ctrl+Z**: 撤销最近的一个操作
- **支持的操作**: 图形添加、删除、移动、形状编辑
- **历史限制**: 最多保存50个操作历史

### 高级功能
- **深度选择**: 通过工具栏复选框启用/禁用遮挡检测
- **累积选择**: 多次选择会累积高亮，不会覆盖之前的选择
- **清除选择**: 点击"清除选择"按钮恢复原始显示
- **撤销系统**: 支持Ctrl+Z撤销所有图形操作
- **快捷键操作**: Del键删除选中图形，Ctrl+Z撤销操作

## 故障排除

### 常见问题

1. **VTK路径错误**: 确保VTK_DIR路径正确指向您的VTK安装目录
2. **Qt路径错误**: 确保Qt5_DIR路径正确指向您的Qt安装目录
3. **编译器版本**: 确保使用与Qt和VTK兼容的编译器版本
4. **PLY文件格式**: 确保PLY文件格式正确，包含点坐标数据

### 调试信息
如果构建失败，请检查：
- CMake错误信息
- 编译器错误信息
- 路径配置是否正确
- VTK和Qt版本兼容性

## 快捷键参考

| 操作 | 快捷键 | 适用情况 |
|------|--------|----------|
| 撤销操作 | Ctrl+Z | 全局有效 |
| 删除图形 | Del | 选中图形时 |
| 撤销顶点 | Backspace | 多边形绘制时 |
| 取消选择 | 点击空白区域 | 图形选中时 |
| 完成多边形 | 右键 | 多边形绘制时 |

## 许可证

本项目仅供学习和研究使用。

## 点云裁剪应用

这是一个基于VTK和Qt的点云处理应用，支持PLY文件的导入和多种形状的选区功能。

### 主要功能

#### 1. 文件导入
- 支持PLY格式点云文件导入
- 自动根据Z轴高度生成颜色映射

#### 2. 画布绘制功能（重构后）
新的选区功能采用"画布"概念，支持多种形状的组合选择：

**绘制工具**：
- **矩形绘制**：拖拽鼠标绘制矩形选区
- **圆形绘制**：拖拽鼠标绘制圆形选区  
- **多边形绘制**：左键放置顶点，Backspace撤销上一个顶点，右键完成绘制

**画布操作**：
- **清空画布**：清除画布上的所有已绘制形状
- **确认选取**：根据画布上所有形状的并集进行实际的点云选取
- **清除选中点**：清除当前高亮显示的选中点

#### 3. 完整工作流程

##### 基础操作
1. **导入点云**：使用"导入PLY"加载点云文件
2. **绘制选区**：
   - 选择绘制工具（矩形/圆形/多边形）
   - 在3D视图中绘制多个形状
   - 所有形状都会保存在"画布"上，用绿色线条显示

##### 图形编辑（新功能）
3. **编辑图形**：
   - 退出绘制模式，点击图形进行选择（变红色）
   - 拖拽控制点调整形状大小或移动顶点
   - 拖拽图形边界移动整个图形
   - 使用Del键删除不需要的图形
   - 使用Ctrl+Z撤销错误操作

##### 完成选取
4. **执行选取**：点击"确认选取"按钮，根据画布上的所有形状执行点云选取
5. **管理选区**：
   - 使用"清空画布"重新开始绘制
   - 使用"清除选中点"清除选取结果

#### 4. 高级功能
- **深度选择**：启用后会过滤被遮挡的点，只选择前景可见的点
- **形状并集**：画布上的多个形状自动形成并集，点在任意形状内都会被选中
- **实时状态**：状态栏显示画布形状数量和选中点数量
- **画布锁定**：锁定画布可以禁用视图旋转和缩放，避免绘制时误操作
- **自动清理**：确认选取后画布会自动清空，准备下次绘制

### 编译和运行

```bash
# 编译
./build.bat

# 运行
# 编译完成后运行生成的可执行文件
```

### 系统要求
- Qt 5.12+
- VTK 8.2+
- CMake 3.16+
- Visual Studio 2019+ (Windows)

### 使用技巧

#### 绘制技巧
1. 可以组合使用不同类型的形状（矩形+圆形+多边形）
2. 绘制过程中，黄色线条表示正在绘制的形状，绿色线条表示已完成的形状
3. 多边形绘制时可以使用Backspace键撤销最后一个顶点
4. 启用深度选择可以避免选中被其他点遮挡的背景点
5. 在绘制复杂形状时，建议勾选"锁定画布"以避免意外的视图操作

#### 编辑技巧
6. **图形选择**: 只有在非绘制模式下才能选择和编辑图形
7. **控制点识别**: 黄色圆点是控制点，可以拖拽调整形状
8. **整体移动**: 点击图形边界（非控制点）可以移动整个图形
9. **快速删除**: 选中图形后按Del键快速删除
10. **安全操作**: 所有操作都可以用Ctrl+Z撤销，不用担心误操作
11. **状态指示**: 红色图形表示选中状态，绿色表示正常状态
12. **编辑精度**: 拖拽操作支持像素级精度，适合精细调整

#### 工作流程技巧
13. 确认选取后画布会自动清空，无需手动清理
14. 建议先完成所有图形的绘制和编辑，再执行"确认选取"
15. 复杂选区可以先绘制大致形状，再通过编辑功能精确调整 